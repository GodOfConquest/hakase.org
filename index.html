<!DOCTYPE html>
<meta charset="utf-8">
<title>hakase dot org</title>

<style>
  html {
    min-width: 450px;
  }

  img { display: block; }

  #hakase {
    position: absolute;
    bottom: 0;
  }

  /* only visually hidden, so images will still load and delay onload */
  #assets {
    clip: rect(0 0 0 0);
    height: 0;
    width; 0;
    position: absolute;
    left: 0;
    top: 0;
  }
</style>

<div id="assets">
  <div id="wleft">
    <img src="walk/left/0.png"/>
    <img src="walk/left/1.png"/>
    <img src="walk/left/2.png"/>
    <img src="walk/left/3.png"/>
    <img src="walk/left/4.png"/>
  </div>
  <div id="wright">
    <img src="walk/right/0.png"/>
    <img src="walk/right/1.png"/>
    <img src="walk/right/2.png"/>
    <img src="walk/right/3.png"/>
    <img src="walk/right/4.png"/>
  </div>
  <div id="tleft">
    <img src="turn/left/0.png"/>
    <img src="turn/left/1.png"/>
    <img src="turn/left/2.png"/>
    <img src="turn/left/3.png"/>
    <img src="turn/left/4.png"/>
    <img src="turn/left/5.png"/>
    <img src="turn/left/6.png"/>
    <img src="turn/left/7.png"/>
    <img src="turn/left/8.png"/>
    <img src="turn/left/9.png"/>
    <img src="turn/left/10.png"/>
    <img src="turn/left/11.png"/>
    <img src="turn/left/12.png"/>
    <img src="turn/left/13.png"/>
  </div>
  <div id="tright">
    <img src="turn/right/0.png"/>
    <img src="turn/right/1.png"/>
    <img src="turn/right/2.png"/>
    <img src="turn/right/3.png"/>
    <img src="turn/right/4.png"/>
    <img src="turn/right/5.png"/>
    <img src="turn/right/6.png"/>
    <img src="turn/right/7.png"/>
    <img src="turn/right/8.png"/>
    <img src="turn/right/9.png"/>
    <img src="turn/right/10.png"/>
    <img src="turn/right/11.png"/>
    <img src="turn/right/12.png"/>
    <img src="turn/right/13.png"/>
    <img src="turn/right/14.png"/>
    <img src="turn/right/15.png"/>
  </div>
</div>

<canvas id="hakase">Hakase dot org</canvas>

<script>
(function () {
"use strict";

// page visibility API polyfill
if (typeof document.hidden !== "undefined") {
  (function () {
    var hidden, visibilityChange;
    if (typeof document.mozHidden !== "undefined") {
      hidden = "mozHidden";
      visibilityChange = "mozvisibilitychange";
    } else if (typeof document.msHidden !== "undefined") {
      hidden = "msHidden";
      visibilityChange = "msvisibilitychange";
    } else if (typeof document.webkitHidden !== "undefined") {
      hidden = "webkitHidden";
      visibilityChange = "webkitvisibilitychange";
    }

    // set the real document.hidden property, and dispatch the polyfilled event
    document.addEventListener(visibilityChange, function () {
      document.hidden = document[hidden];
      document.dispatchEvent(new CustomEvent("visibilitychange"));
    });
  })();
}

// utility to get the asset's children as a regualr array of elements
function images(id) {
  return Array.prototype.slice.call(document.getElementById(id).children);
}

// The parts of the animation overlap slightly, so this is the true width
// to shift the container by when moving
var TURN_WIDTH_LEFT = 55,
    TURN_WIDTH_RIGHT = 170,
    WALK_LEFT_START = 266,
    WALK_RIGHT_START = 150,
    WALK_WIDTH = {
      left: [-27, -32, -19, -22, -25],
      right: [27, 32, 19, 22, 25]
    };

window.addEventListener('load', function () {

  var hakase = document.getElementById('hakase'),
      ctx = hakase.getContext('2d'),
      // swapping out the DOM img elements creates artifacts that don't
      // appear when just redrawing to the same canvas. Weird.
      draw = function (img) {
        // resetting the canvas width/height has the added effect of clearing it
        hakase.width = img.width;
        hakase.height = img.height;

        ctx.drawImage(img, 0, 0);
      },
      turn = {
        left: images('tleft'),
        right: images('tright')
      },
      walk = {
        left: images('wleft'),
        right: images('wright')
      },
      x         = -250, // cutely walk into the screen from stage left
      walking   = true,
      direction = "right",
      anim      = walk[direction],
      frames    = anim.length,
      frame     = 0;

  hakase.style.left = x + 'px';
  draw(anim[frame]);

  // animation loop
  setTimeout(function tick () {
    ++frame;

    if (walking) {
      frame = frame % frames;

      x += WALK_WIDTH[direction][frame];

      if ( direction === "right" && (window.innerWidth - x) < TURN_WIDTH_RIGHT ||
           direction === "left" && x < TURN_WIDTH_LEFT ) {

        walking = false;
        if (direction === "right") {
          direction = "left";
          x = window.innerWidth - 266; // width of actual turning anim
        } else { // left
          direction = "right";
          x = 0;
        }

        anim = turn[direction];
        frames = anim.length;
        frame = 0;
      }
    } else { // turning
      if (frame >= frames) {
        walking = true;
        anim = walk[direction];
        frames = anim.length;
        frame = 0;

        x = direction === "right" ?
          WALK_RIGHT_START :
          window.innerWidth - WALK_LEFT_START;
      }
    }

    hakase.style.left = x + 'px';

    draw(anim[frame]);



    if (document.hidden) {
      // continue once we're no longer hidden
      document.addEventListener("visibilitychange", function () {
        setTimeout(tick, 120);
      });
    } else {
      setTimeout(tick, 120);
    }
  }, 120);

});
})();
</script>
