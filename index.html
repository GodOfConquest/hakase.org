<!DOCTYPE html>
<meta charset="utf-8">
<title>hakase.org</title>

<link rel="icon" href="favicon.ico">

<link href='http://fonts.googleapis.com/css?family=Vollkorn:700' rel='stylesheet' type='text/css'>

<style>
  html {
    min-width: 450px;
    min-height: 100%;
    box-shadow: 0 0 150px #aaa inset; /* pleasant vingette */
    background-image: url("data:image/png;base64,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");
  }

  html, body { margin: 0; padding: 0; }

  #title {
    font-family: 'Volkorn', serif;
    font-weight: 700;
    font-size: 150px;
    text-align: center;

    color: white;
    text-shadow: 3px 3px 0 black, 0 0 100px #999999, 10px 10px 15px #AAAAAA;

    margin: auto;
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    height: 150px;
  }

  #hakase {
    position: absolute;
    bottom: 0;
  }

  /* only visually hidden, so images will still load and delay onload */
  #assets {
    clip: rect(0 0 0 0);
    height: 0;
    width; 0;
    position: absolute;
    left: 0;
    top: 0;
  }
</style>

<h1 id="title">hakase.org</h1>

<div id="assets">
  <div id="wleft">
    <img src="walk/left/0.png"/>
    <img src="walk/left/1.png"/>
    <img src="walk/left/2.png"/>
    <img src="walk/left/3.png"/>
    <img src="walk/left/4.png"/>
  </div>
  <div id="wright">
    <img src="walk/right/0.png"/>
    <img src="walk/right/1.png"/>
    <img src="walk/right/2.png"/>
    <img src="walk/right/3.png"/>
    <img src="walk/right/4.png"/>
  </div>
  <div id="tleft">
    <img src="turn/left/0.png"/>
    <img src="turn/left/1.png"/>
    <img src="turn/left/2.png"/>
    <img src="turn/left/3.png"/>
    <img src="turn/left/4.png"/>
    <img src="turn/left/5.png"/>
    <img src="turn/left/6.png"/>
    <img src="turn/left/7.png"/>
    <img src="turn/left/8.png"/>
    <img src="turn/left/9.png"/>
    <img src="turn/left/10.png"/>
    <img src="turn/left/11.png"/>
    <img src="turn/left/12.png"/>
    <img src="turn/left/13.png"/>
  </div>
  <div id="tright">
    <img src="turn/right/0.png"/>
    <img src="turn/right/1.png"/>
    <img src="turn/right/2.png"/>
    <img src="turn/right/3.png"/>
    <img src="turn/right/4.png"/>
    <img src="turn/right/5.png"/>
    <img src="turn/right/6.png"/>
    <img src="turn/right/7.png"/>
    <img src="turn/right/8.png"/>
    <img src="turn/right/9.png"/>
    <img src="turn/right/10.png"/>
    <img src="turn/right/11.png"/>
    <img src="turn/right/12.png"/>
    <img src="turn/right/13.png"/>
    <img src="turn/right/14.png"/>
    <img src="turn/right/15.png"/>
  </div>
</div>

<canvas id="hakase" height="119">Hakase dot org</canvas>

<script>
(function () {
"use strict";

// stretch title stuff
// adapted from https://github.com/davatron5000/FitText.js

function debounce(time, fn) {
  var timeout;
  return function () {
    var ctx = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(function () {
      fn.apply(this, args);
    }, time);
  };
}

// behold my carefully tuned constants
function resize() {
  var h1 = document.getElementById('title');
  h1.style.fontSize = (window.innerWidth / 7) + 'px';
  h1.style.height = (window.innerWidth / 5) + 'px';
}

document.addEventListener('DOMContentLoaded', function () {
  resize();
  window.addEventListener('resize', debounce(300, resize));
});

// page visibility API polyfill
if (typeof document.hidden !== "undefined") {
  (function () {
    var hidden, visibilityChange;
    if (typeof document.mozHidden !== "undefined") {
      hidden = "mozHidden";
      visibilityChange = "mozvisibilitychange";
    } else if (typeof document.msHidden !== "undefined") {
      hidden = "msHidden";
      visibilityChange = "msvisibilitychange";
    } else if (typeof document.webkitHidden !== "undefined") {
      hidden = "webkitHidden";
      visibilityChange = "webkitvisibilitychange";
    }

    // set the real document.hidden property, and dispatch the polyfilled event
    document.addEventListener(visibilityChange, function () {
      document.hidden = document[hidden];
      document.dispatchEvent(new CustomEvent("visibilitychange"));
    });
  })();
}

// utility to get the asset's children as a regualr array of elements
function images(id) {
  return Array.prototype.slice.call(document.getElementById(id).children);
}

// The parts of the animation overlap slightly, so this is the true width
// to shift the container by when moving
var TURN_WIDTH_LEFT = 55,
    TURN_WIDTH_RIGHT = 170,
    WALK_LEFT_START = 266,
    WALK_RIGHT_START = 150,
    WALK_WIDTH = {
      left: [-27, -32, -19, -22, -25],
      right: [27, 32, 19, 22, 25]
    };

window.addEventListener('load', function () {

  var hakase = document.getElementById('hakase'),
      ctx = hakase.getContext('2d'),
      // swapping out the DOM img elements creates artifacts that don't
      // appear when just redrawing to the same canvas. Weird.
      turn = {
        left: images('tleft'),
        right: images('tright')
      },
      walk = {
        left: images('wleft'),
        right: images('wright')
      },

      x         = -250, // cutely walk into the screen from stage left
      walking   = true,
      direction = "right",
      anim      = walk[direction],
      frames    = anim.length,
      frame     = 0,

      draw = function () {
        // resetting the canvas width has the added effect of clearing it
        hakase.width = window.innerWidth;

        // not all the images are the same height, and it's a goddamn hassle to
        // either figure out how to script them to the same height, or to do it
        // manually with GIMP's god-awful interface
        ctx.drawImage(anim[frame], x, 119 - anim[frame].height);
      };

  draw();

  // animation loop
  setTimeout(function tick () {
    ++frame;

    if (walking) {
      frame = frame % frames;

      x += WALK_WIDTH[direction][frame];

      if ( direction === "right" && (window.innerWidth - x) < TURN_WIDTH_RIGHT ||
           direction === "left" && x < TURN_WIDTH_LEFT ) {

        walking = false;
        if (direction === "right") {
          direction = "left";
          x = window.innerWidth - 266; // width of actual turning anim
        } else { // left
          direction = "right";
          x = 0;
        }

        anim = turn[direction];
        frames = anim.length;
        frame = 0;
      }
    } else { // turning
      if (frame >= frames) {
        walking = true;
        anim = walk[direction];
        frames = anim.length;
        frame = 0;

        x = direction === "right" ?
          WALK_RIGHT_START :
          window.innerWidth - WALK_LEFT_START;
      }
    }

    draw();

    if (document.hidden) {
      // continue once we're no longer hidden
      document.addEventListener("visibilitychange", function restart () {
        setTimeout(tick, 120);
        document.removeEventListener("visibilitychange", restart);
      });
    } else {
      setTimeout(tick, 120);
    }
  }, 120);

});
})();
</script>
